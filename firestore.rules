rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Aturan untuk Profil Pengguna ---
    // Pengguna hanya bisa membaca dan menulis profilnya sendiri.
    match /users/{userId} {
      allow read, update, delete: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null;
      allow list: if false; // Mencegah siapa pun melihat daftar semua pengguna.
    }

    // --- Aturan untuk Halaman (Versi Privat/Editor) ---
    // Hanya pemilik yang dapat melakukan semua operasi pada halamannya.
    match /pages/{pageId} {
      // Izinkan baca, update, hapus jika UID pengguna cocok dengan userId di dokumen.
      allow read, update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Izinkan pembuatan jika UID pengguna cocok dengan userId yang akan dibuat.
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      
      allow list: if false;

      // --- Aturan untuk Sub-koleksi Submission ---
      // Siapa saja bisa mengirim form, tetapi hanya pemilik halaman yang bisa membacanya.
      match /submissions/{submissionId} {
        function isParentPageOwner() {
          return request.auth != null && request.auth.uid == get(/databases/$(database)/documents/pages/$(pageId)).data.userId;
        }
        
        allow read, list: if isParentPageOwner();
        allow create: if true;
        allow update, delete: if false;
      }
    }

    // --- Aturan untuk Halaman (Versi Publik) ---
    // Siapa saja bisa membaca (get, list).
    // HANYA pemilik halaman asli yang bisa menulis (create, update, delete).
    match /publishedPages/{pageId} {
      allow read, list: if true;

      function isOriginalPageOwner() {
        // Memeriksa apakah pengguna yang mencoba menulis adalah pemilik halaman asli di koleksi 'pages'.
        let pageDoc = get(/databases/$(database)/documents/pages/$(pageId));
        return request.auth != null && request.auth.uid == pageDoc.data.userId;
      }
      
      // ðŸ”¥ PERBAIKAN UTAMA ADA DI SINI ðŸ”¥
      // Izinkan semua operasi tulis (simpan, publish, unpublish) hanya untuk pemilik halaman.
      allow write: if isOriginalPageOwner();
    }
  }
}